---
- name: raspbian
  hosts: raspbian:!clusterpi3
  connection: ssh
  gather_facts: false
  become: false

  tasks:

    - name: include latest
      when: latest | default(false, true)
      ansible.builtin.include_role:
        name: ubuntu
        tasks_from: latest.yml

    - name: include packages
      when: packages | default(false, true)
      ansible.builtin.include_role:
        name: ubuntu
        tasks_from: packages.yml

    - name: include user (mark)
      when: mark | default(false, true)
      ansible.builtin.include_role:
        name: ubuntu
        tasks_from: user/mark.yml

    - name: include user (concourse)
      when: concourse | default(false, true)
      ansible.builtin.include_role:
        name: ubuntu
        tasks_from: user/concourse.yml

    - name: set leader options
      ansible.builtin.set_fact:
        k3s_options: "--cluster-init"
        fetch_kubeconfig: true
      when: inventory_hostname == "clusterpi0"

    - name: set member options
      ansible.builtin.set_fact:
        k3s_options: "--server https://clusterpi0.cloudmason.org:6443"
        fetch_kubeconfig: false
      when: inventory_hostname != "clusterpi0"

    - name: include k3s
      when: k3s | default(false, true)
      ansible.builtin.include_role:
        name: k3s
        tasks_from: main
      vars:
        version: v1.19.15%2Bk3s2
        binary: k3s-armhf
        sha256: d3250017ac051b9aa3e03a6dd80f2a2696502e4385eb14df9f0964ac8905eaa4
        token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31343336303733326134663261633463346634386662306538396238326462363037646330306338
          3664313635626661623236643939346139386463666266390a653766663261646335616561363634
          66333061353137353238613863326462343165346161346435353836383764636539643135396333
          3635623964393532340a303035663236663839356361616230636661396538326564356134313932
          3365
        options: "{{ k3s_options }} --disable servicelb --write-kubeconfig-mode 0644"
